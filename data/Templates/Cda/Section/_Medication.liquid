{% assign firstSections = msg | get_first_cda_sections_by_template_id: '2.16.840.1.113883.10.20.22.2.1.1' -%}
{% assign entries = firstSections.2_16_840_1_113883_10_20_22_2_1_1.entry | to_array -%}
{% for e in entries -%}
    {% if e.substanceAdministration -%}
        {% assign medicationStatementId = e.substanceAdministration | to_json_string | generate_uuid -%}
        {% include 'Resource/MedicationStatement' medicationStatement: e.substanceAdministration, ID: medicationStatementId -%}
        {% include 'Reference/MedicationStatement/Subject' ID: medicationStatementId, REF: fullPatientId -%}
    {% endif -%}

    {% if e.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial -%}
        {% assign medicationId = e.substanceAdministration.consumable | to_json_string | generate_uuid -%}
        {% include 'Resource/Medication' medication: e.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial, ID: medicationId -%}
        {% assign fullMedicationId = medicationId | prepend: 'Medication/' -%}
        {% include 'Reference/MedicationStatement/MedicationReference' ID: medicationStatementId, REF: fullMedicationId -%}

        {% assign relationships = e.substanceAdministration.entryRelationship -%}
        {% for r in relationships -%}
            {% if r.supply -%}
                {% assign medicationRequestId = r.supply | to_json_string | generate_uuid -%}
                {% include 'Resource/MedicationRequest' medicationRequest: r.supply, ID: medicationRequestId -%}
                {% include 'Reference/MedicationRequest/Subject' ID: medicationRequestId, REF: fullPatientId -%}
                {% include 'Reference/MedicationRequest/MedicationReference' ID: medicationRequestId, REF: fullMedicationId -%}
            {% endif -%}
            {% if r.supply.author.assignedAuthor -%}
                {% evaluate practitionerId using 'Utils/GenerateId' obj: r.supply.author.assignedAuthor -%}
                {% include 'Resource/Practitioner' practitioner: r.supply.author.assignedAuthor, ID: practitionerId -%}
                {% assign fullPractitionerId = practitionerId | prepend: 'Practitioner/' -%}
                {% include 'Reference/MedicationRequest/requester' ID: medicationRequestId, REF: fullPractitionerId -%}
            {% endif -%}
        {% endfor -%}
    {% endif -%}

    {% if e.substanceAdministration.informant.assignedEntity.representedOrganization.name._ -%}
        {% assign organizationId = e.substanceAdministration.informant.assignedEntity.representedOrganization | to_json_string | generate_uuid -%}
        {% include 'Resource/Organization' org: e.substanceAdministration.informant.assignedEntity.representedOrganization ID: organizationId -%}
    {% endif -%}
{% endfor -%}