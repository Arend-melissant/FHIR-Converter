{
    "resourceType": "Bundle",
    "type": "transaction",
    "entry": [
    	{{#with msg.ClinicalDocument}}
      		{{>Resources/Composition.hbs composition=this ID=(generateUUID (toJsonString this))}},
            {{>Resources/Practitioner.hbs practitioner=this.legalAuthenticator.assignedEntity ID=(generateUUID (toJsonString this.legalAuthenticator.assignedEntity))}},
      		{{>References/Composition/subject.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Patient/' (generateUUID (toJsonString this.recordTarget.patientRole)))}}
    		{{>References/Composition/attester.party.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Practitioner/' (generateUUID (toJsonString this.legalAuthenticator.assignedEntity)))}}
    		{{>References/Composition/custodian.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Organization/' (generateUUID (toJsonString this.custodian)))}}
        {{/with}}
    	
        {{#if msg.ClinicalDocument.author.assignedAuthor.assignedAuthoringDevice}}
        	 {{>Resources/Device.hbs author=msg.ClinicalDocument.author.assignedAuthor ID=(generateUUID (toJsonString msg.ClinicalDocument.author))}},
      		 {{>Resources/Organization.hbs org=msg.ClinicalDocument.author.assignedAuthor.representedOrganization ID=(generateUUID (toJsonString msg.ClinicalDocument.author.assignedAuthor.representedOrganization))}},
             {{>References/Composition/author.hbs ID=(generateUUID (toJsonString msg.ClinicalDocument)) REF=(concat 'Device/' (generateUUID (toJsonString msg.ClinicalDocument.author)))}},
			 {{>References/Device/owner.hbs ID=(generateUUID (toJsonString msg.ClinicalDocument.author)) REF=(concat 'Organization/' (generateUUID (toJsonString msg.ClinicalDocument.author.assignedAuthor.representedOrganization)))}}         
        {{/if}}
    
        {{#with msg.ClinicalDocument.recordTarget.patientRole}}
            {{>Resources/Patient.hbs patientRole=this ID=(generateUUID (toJsonString this))}},
            {{>Resources/Organization.hbs org=this.providerOrganization ID=(generateUUID (toJsonString this.providerOrganization))}},
            {{>References/Patient/managingOrganization.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Organization/' (generateUUID (toJsonString this.providerOrganization)))}},
		{{/with}}
        
      	{{#with msg.ClinicalDocument.documentationOf.serviceEvent.performer}}
        	{{#each this}}
      			{{>Resources/Practitioner.hbs practitioner=this.assignedEntity ID=(generateUUID (toJsonString this))}},
            {{/each}}
        {{/with}}
        
      	{{#with (getFirstCdaSections msg 'Medication')}}
            {{#each (toArray Medication.entry) as |medEntry|}}
                {{>Resources/MedicationStatement.hbs medicationStatement=medEntry.substanceAdministration ID=(generateUUID (toJsonString medEntry.substanceAdministration))}},
                {{>Resources/Medication.hbs medication=medEntry.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial.name ID=(generateUUID (toJsonString medEntry.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial.name))}},
                {{>Resources/Organization.hbs org=medEntry.substanceAdministration.informant.assignedEntity ID=(generateUUID (toJsonString medEntry.substanceAdministration.informant.assignedEntity))}},
                {{>References/MedicationStatement/medicationReference.hbs ID=(generateUUID (toJsonString medEntry.substanceAdministration)) REF=(concat 'Medication/' (generateUUID (toJsonString medEntry.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial.name)))}},
            	{{>References/MedicationStatement/subject.hbs ID=(generateUUID (toJsonString medEntry.substanceAdministration)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                {{#each (toArray this.substanceAdministration.entryRelationship) as |medReq|}}
                    {{>Resources/MedicationRequest.hbs medicationRequest=medReq.supply ID=(generateUUID (toJsonString medReq.supply))}},
                    {{>Resources/Practitioner.hbs practitioner=medReq.supply.author.assignedAuthor ID=(generateUUID (toJsonString medReq.supply.author.assignedAuthor))}},
                    {{>References/MedicationRequest/medicationReference.hbs ID=(generateUUID (toJsonString this.supply)) REF=(concat 'Medication/' (generateUUID (toJsonString medEntry.substanceAdministration.consumable)))}},
                    {{>References/MedicationRequest/subject.hbs ID=(generateUUID (toJsonString this.supply)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                    {{>References/MedicationRequest/requester.hbs ID=(generateUUID (toJsonString this.supply)) REF=(concat 'Practitioner/' (generateUUID (toJsonString medReq.supply.author.assignedAuthor)))}}
                {{/each}}  
            {{/each}}
        {{/with}}
         
        {{#with (getFirstCdaSections msg 'Allergies')}}
            {{#each (toArray Allergies.entry) as |alEntry|}}
                {{>Resources/AllergyIntolerance.hbs allergyEntry=alEntry ID=(generateUUID (toJsonString alEntry))}},
                {{>References/AllergyIntolerance/patient.hbs ID=(generateUUID (toJsonString alEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
            {{/each}}
        {{/with}}
        
        {{#with (getFirstCdaSections msg 'Problems')}}
            {{#each (toArray Problems.entry) as |condEntry|}}
                {{>Resources/Condition.hbs conditionEntry=condEntry.act ID=(generateUUID (toJsonString condEntry.act))}},
                {{>References/Condition/subject.hbs ID=(generateUUID (toJsonString condEntry.act)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
            {{/each}}
        {{/with}} 
        
      	{{#with (getFirstCdaSections msg 'Vital')}}
        	{{#each (toArray Vital.entry)}}
            	{{#each (toArray this.organizer.component) as |obsEntry|}}
            		{{>Resources/Observation.hbs observationEntry=obsEntry.observation ID=(generateUUID (toJsonString obsEntry.observation))}}
                    {{>References/Observation/subject.hbs ID=(generateUUID (toJsonString obsEntry.observation)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../../msg.ClinicalDocument.recordTarget.patientRole)))}}
            	{{/each}}
            {{/each}}
        {{/with}}
        
      	{{#with (getFirstCdaSections msg 'Social')}}
        	{{#each (toArray Social.entry) as |obsEntry|}}
            	{{>Resources/Observation.hbs observationEntry=obsEntry.observation ID=(generateUUID (toJsonString obsEntry.observation))}} 
                {{>References/Observation/subject.hbs ID=(generateUUID (toJsonString obsEntry.observation)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}}
            {{/each}}
        {{/with}}
        
        {{#with (getFirstCdaSections msg 'Immunization')}}
            {{#each (toArray Immunization.entry) as |immEntry|}}
                {{>Resources/Immunization.hbs imm=immEntry.substanceAdministration ID=(generateUUID (toJsonString immEntry))}},
                {{#if (eq immEntry.substanceAdministration.informant.assignedEntity.id.root 'FACILITY')}}
                    {{>Resources/Organization.hbs org=immEntry.substanceAdministration.informant.assignedEntity.representedOrganization ID=(generateUUID (toJsonString immEntry.substanceAdministration.informant.assignedEntity.representedOrganization))}},
                    {{>References/Immunization/performer.actor.hbs ID=(generateUUID (toJsonString immEntry)) REF=(concat 'Organization/' (generateUUID (toJsonString immEntry.substanceAdministration.informant.assignedEntity.representedOrganization)))}},
                {{/if}}
                {{>References/Immunization/patient.hbs ID=(generateUUID (toJsonString immEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
            {{/each}}
        {{/with}}
        
        {{#with (getFirstCdaSections msg 'Results')}}
            {{#each (toArray Results.entry) as |drEntry|}}
                {{>Resources/DiagnosticReport.hbs diagReport=drEntry.organizer ID=(generateUUID (toJsonString drEntry.organizer))}},
                {{>References/DiagnosticReport/subject.hbs ID=(generateUUID (toJsonString drEntry.organizer)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                {{#each (toArray this.organizer.component) as |obsEntry|}}
                    {{#if obsEntry.observation}}
                        {{>Resources/Observation.hbs observationEntry=obsEntry.observation ID=(generateUUID (toJsonString obsEntry.observation))}},                   
                        {{>References/DiagnosticReport/result.hbs ID=(generateUUID (toJsonString drEntry.organizer)) REF=(concat 'Observation/' (generateUUID (toJsonString obsEntry.observation)))}},
                        {{>References/Observation/subject.hbs ID=(generateUUID (toJsonString obsEntry.observation)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                    {{/if}}
                {{/each}}
            {{/each}}
        {{/with}}
        
        {{#with (getFirstCdaSections msg 'Encounters')}}
            {{#each (toArray Encounters.entry) as |encounterEntry|}}
                {{>Resources/Encounter.hbs encounter=encounterEntry.encounter ID=(generateUUID (toJsonString encounterEntry))}},
                {{>Resources/Practitioner.hbs practitioner=encounterEntry.encounter.performer.assignedEntity ID=(generateUUID (toJsonString encounterEntry.encounter.performer.assignedEntity))}},
                {{>References/Encounter/subject.hbs ID=(generateUUID (toJsonString encounterEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                {{>References/Encounter/participant.individual.hbs ID=(generateUUID (toJsonString encounterEntry)) REF=(concat 'Practitioner/' (generateUUID (toJsonString encounterEntry.encounter.performer.assignedEntity)))}},

                {{#each (toArray encounterEntry.encounter.participant)}}
                    {{#if (eq this.typeCode 'LOC')}}
                	    {{#if (contains (toJsonString this.participantRole.templateId) '2.16.840.1.113883.10.20.22.4.32')}}
               			    {{>Resources/Location.hbs location=this.participantRole ID=(generateUUID (toJsonString this.participantRole))}},
                		    {{>References/Encounter/location.location.hbs ID=(generateUUID (toJsonString encounterEntry)) REF=(concat 'Location/' (generateUUID (toJsonString this.participantRole)))}},                    
                        {{/if}}                
                    {{/if}}
                {{/each}}
            {{/each}}
        {{/with}}
        
         {{>Resources/DocumentReference.hbs docref=msg ID=(generateUUID (toJsonString msg))}}
      ]
}