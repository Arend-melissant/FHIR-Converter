{
    "resourceType": "Bundle",
    "type": "transaction",
    "entry": [
    	{{#with msg.ClinicalDocument}}
      		{{>Resources/Composition.hbs composition=this ID=(generateUUID (toJsonString this))}},
            {{>Resources/Practitioner.hbs practitioner=this.legalAuthenticator.assignedEntity ID=(generateUUID (toJsonString this.legalAuthenticator.assignedEntity))}},
      		{{>References/Composition/subject.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Patient/' (generateUUID (toJsonString this.recordTarget.patientRole)))}}
    		{{>References/Composition/attester.party.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Practitioner/' (generateUUID (toJsonString this.legalAuthenticator.assignedEntity)))}}
    		{{>References/Composition/custodian.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Organization/' (generateUUID (toJsonString this.custodian)))}}
        {{/with}}
    	
        {{#if msg.ClinicalDocument.author.assignedAuthor.assignedAuthoringDevice}}
        	 {{>Resources/Device.hbs author=msg.ClinicalDocument.author.assignedAuthor ID=(generateUUID (toJsonString msg.ClinicalDocument.author))}},
      		 {{>Resources/Organization.hbs org=msg.ClinicalDocument.author.assignedAuthor.representedOrganization ID=(generateUUID (toJsonString msg.ClinicalDocument.author.assignedAuthor.representedOrganization))}},
             {{>References/Composition/author.hbs ID=(generateUUID (toJsonString msg.ClinicalDocument)) REF=(concat 'Device/' (generateUUID (toJsonString msg.ClinicalDocument.author)))}},
			 {{>References/Device/owner.hbs ID=(generateUUID (toJsonString msg.ClinicalDocument.author)) REF=(concat 'Organization/' (generateUUID (toJsonString msg.ClinicalDocument.author.assignedAuthor.representedOrganization)))}}         
        {{/if}}
    
        {{#with msg.ClinicalDocument.recordTarget.patientRole}}
            {{>Resources/Patient.hbs patientRole=this ID=(generateUUID (toJsonString this))}},
            {{>Resources/Organization.hbs org=this.providerOrganization ID=(generateUUID (toJsonString this.providerOrganization))}},
            {{>References/Patient/managingOrganization.hbs ID=(generateUUID (toJsonString this)) REF=(concat 'Organization/' (generateUUID (toJsonString this.providerOrganization)))}},
		{{/with}}
        
      	{{#with msg.ClinicalDocument.documentationOf.serviceEvent.performer}}
        	{{#each this}}
      			{{>Resources/Practitioner.hbs practitioner=this.assignedEntity ID=(generateUUID (toJsonString this))}},
            {{/each}}
        {{/with}}
        
      	{{#with (getFirstCdaSections msg 'Medication')}}
            {{#each (toArray Medication.entry) as |medEntry|}}
                {{>Resources/MedicationStatement.hbs medicationEntry=medEntry ID=(generateUUID (toJsonString medEntry))}},
                {{>References/MedicationStatement/medicationReference.hbs ID=(generateUUID (toJsonString medEntry)) REF=(concat 'Medication/' (generateUUID (toJsonString medEntry.substanceAdministration.consumable)))}}
            	{{>References/MedicationStatement/subject.hbs ID=(generateUUID (toJsonString medEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
            {{/each}}
        {{/with}}
         
        {{#with (getFirstCdaSections msg 'Allergies')}}
            {{#each (toArray Allergies.entry) as |alEntry|}}
                {{>Resources/AllergyIntolerance.hbs allergyEntry=alEntry ID=(generateUUID (toJsonString alEntry))}},
                {{>References/AllergyIntolerance/patient.hbs ID=(generateUUID (toJsonString alEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
            {{/each}}
        {{/with}}
        
      	{{#with (getFirstCdaSections msg 'Vital')}}
        	{{#each (toArray Vital.entry)}}
            	{{#each (toArray this.organizer.component) as |obsEntry|}}
            		{{>Resources/Observation.hbs observationEntry=obsEntry.observation ID=(generateUUID (toJsonString obsEntry.observation))}}
                    {{>References/Observation/subject.hbs ID=(generateUUID (toJsonString obsEntry.observation)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}}
            	{{/each}}
            {{/each}}
        {{/with}}
        
      	{{#with (getFirstCdaSections msg 'Social')}}
        	{{#each (toArray Social.entry) as |obsEntry|}}
            	{{>Resources/Observation.hbs observationEntry=obsEntry.observation ID=(generateUUID (toJsonString obsEntry.observation))}} 
                {{>References/Observation/subject.hbs ID=(generateUUID (toJsonString obsEntry.observation)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}}
            {{/each}}
        {{/with}}
        
        {{#with (getFirstCdaSections msg 'Immunization')}}
            {{#each (toArray Immunization.entry) as |immEntry|}}
                {{>Resources/Immunization.hbs imm=immEntry.substanceAdministration ID=(generateUUID (toJsonString immEntry))}},
                {{>Resources/Practitioner.hbs practitioner=immEntry.substanceAdministration.informant.assignedEntity ID=(generateUUID (toJsonString immEntry.substanceAdministration.informant.assignedEntity))}},
                {{>Resources/Organization.hbs org=immEntry.substranceAdministration.informant.assignedEntity.representedOrganization ID=(generateUUID (toJsonString immEntry.substranceAdministration.informant.assignedEntity.representedOrganization))}},
                {{>References/Immunization/patient.hbs ID=(generateUUID (toJsonString immEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                {{>References/Immunization/performer.actor.hbs ID=(generateUUID (toJsonString immEntry)) REF=(concat 'Practitioner/' (generateUUID (toJsonString immEntry.substanceAdministration.performer.assignedEntity)))}},
            {{/each}}
        {{/with}}
        
        {{#with (getFirstCdaSections msg 'Encounters')}}
            {{#each (toArray Encounters.entry) as |encounterEntry|}}
                {{>Resources/Encounter.hbs encounter=encounterEntry.encounter ID=(generateUUID (toJsonString encounterEntry))}},
                {{>Resources/Practitioner.hbs practitioner=encounterEntry.encounter.performer.assignedEntity ID=(generateUUID (toJsonString encounterEntry.encounter.performer.assignedEntity))}},
                {{>References/Encounter/subject.hbs ID=(generateUUID (toJsonString encounterEntry)) REF=(concat 'Patient/' (generateUUID (toJsonString ../../msg.ClinicalDocument.recordTarget.patientRole)))}},
                {{>References/Encounter/participant.individual.hbs ID=(generateUUID (toJsonString encounterEntry)) REF=(concat 'Practitioner/' (generateUUID (toJsonString encounterEntry.encounter.performer.assignedEntity)))}},

                {{#if (eq encounterEntry.encounter.participant.typeCode 'LOC')}}
                	{{#if (contains (toJsonString encounterEntry.encounter.participant.participantRole.templateId) '2.16.840.1.113883.10.20.22.4.32')}}
               			{{>Resources/Location.hbs location=encounterEntry.encounter.participant.participantRole ID=(generateUUID (toJsonString encounterEntry.encounter.participant.participantRole))}},
                		{{>References/Encounter/location.location.hbs ID=(generateUUID (toJsonString encounterEntry)) REF=(concat 'Location/' (generateUUID (toJsonString encounterEntry.encounter.participant.participantRole)))}},                    
                    {{/if}}                
                {{/if}}
            {{/each}}
        {{/with}}
      ]
}